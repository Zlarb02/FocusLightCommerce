<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alto Lille</title>
    <meta
      name="description"
      content="Lampe d'appoint FOCUS.01 écologique et design, fabriquée en PLA écoresponsable et en chêne écogéré. Disponible en 4 couleurs."
    />
    <link rel="icon" type="image/png" href="/images/logo.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600&family=Jost:wght@500;600;700&family=League+Spartan:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-color: #fff;
        --text-color: #111;
        --text-light: #777777;
        --polaroid-border: #fff;
        --polaroid-shadow: rgba(0, 0, 0, 0.15);
        --scroll-indicator-bg: rgba(255, 255, 255, 0.75);
        --scroll-indicator-shadow: rgba(0, 0, 0, 0.1);
        --toggle-bg: #f0f0f0;
        --toggle-bg-active: #2196f3;
        --toggle-knob: #fff;
      }

      .dark-mode {
        --bg-color: #000000;
        --text-color: #f1f1f1;
        --text-light: #aaaaaa;
        --polaroid-border: #ffffff;
        --polaroid-shadow: rgba(255, 255, 255, 0.2);
        --scroll-indicator-bg: rgba(20, 20, 20, 0.75);
        --scroll-indicator-shadow: rgba(0, 0, 0, 0.3);
        --toggle-bg: #333333;
        --toggle-bg-active: #5599ff;
        --toggle-knob: #f0f0f0;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
        background: var(--bg-color);
        font-family: "Noto Sans", system-ui, sans-serif;
        color: var(--text-color);
        transition: background 0.3s, color 0.3s;
      }
      #landing-container {
        background: var(--bg-color);
      }
      #webgl {
        position: fixed;
        inset: 0;
        transition: margin-left 0.3s ease-out;
      }
      #scrollArea {
        height: 800vh;
      }
      .caption {
        position: fixed;
        max-width: 35vw;
        font-size: clamp(18px, 3.5vw, 36px);
        line-height: 1.25;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.4s, color 0.3s;
        pointer-events: none;
        font-family: "Noto Sans", sans-serif;
        color: var(--text-color);
      }
      .tl {
        top: 6%;
        left: 6%;
      }
      .tr {
        top: 6%;
        right: 6%;
      }
      .ml {
        top: 55%;
        left: 6%;
      }
      .mr {
        top: 45%;
        right: 6%;
      }
      .br {
        bottom: 10%;
        right: 6%;
      }
      .bl {
        bottom: 4%;
        left: 6%;
      }
      #cta {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "League Spartan", sans-serif;
        font-size: clamp(32px, 6vw, 72px);
        font-weight: 700;
        opacity: 0;
        transition: opacity 0.6s;
        cursor: pointer;
        color: var(--text-color);
      }

      /* Style pour le footer de la landing page uniquement */
      #landing-container footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        font-size: clamp(0.7rem, 1vw, 0.8rem);
        color: var(--text-light);
        padding: clamp(0.5rem, 1vw, 1rem);
        z-index: 10;
        pointer-events: none;
      }

      /* Style pour les toggles en haut à droite */
      .toggle-container {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 15px;
        z-index: 100;
      }

      .toggle {
        position: relative;
        display: flex;
        align-items: center;
      }

      .toggle-label {
        font-size: 14px;
        margin-right: 10px;
        color: var(--text-color);
        font-weight: 500;
        user-select: none;
      }

      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--toggle-bg);
        transition: 0.4s;
        border-radius: 24px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: var(--toggle-knob);
        transition: 0.3s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--toggle-bg-active);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      /* Configuration de l'effet de parallaxe pour les polaroids */
      .polaroid {
        position: absolute;
        width: 18vw;
        aspect-ratio: 3/4;
        background-size: cover;
        background-position: center;
        border: 8px solid var(--polaroid-border);
        box-shadow: 0 4px 10px var(--polaroid-shadow);
        z-index: 1;
        opacity: 0;
        transition: opacity 0.4s, transform 0.1s ease-out; /* Ajout de transition pour transform */
      }

      /* Masquer l'app React par défaut */
      #root {
        display: none;
      }

      #landing-container {
        display: block;
      }

      /* Style pour le titre de la marque */
      #brand-title {
        position: fixed;
        top: 6%;
        left: 0;
        right: 0;
        text-align: center;
        font-family: "League Spartan", sans-serif;
        font-size: clamp(32px, 5vw, 58px);
        font-weight: 700;
        color: var(--text-color);
        opacity: 0;
        transition: opacity 0.6s, color 0.3s;
        z-index: 10;
      }

      /* Style pour le message de scroll */
      #scroll-indicator {
        position: fixed;
        bottom: 15%;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        font-family: "Noto Sans", system-ui, sans-serif;
        opacity: 0;
        transition: opacity 0.6s, background-color 0.3s, box-shadow 0.3s;
        z-index: 15;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.8rem;
        background-color: var(--scroll-indicator-bg);
        padding: 12px 24px;
        border-radius: 12px;
        backdrop-filter: blur(5px);
        box-shadow: 0 2px 10px var(--scroll-indicator-shadow);
        max-width: 90%;
      }

      /* Style pour les polaroids */
      .polaroid {
        position: absolute;
        width: 18vw;
        aspect-ratio: 3/4;
        z-index: 1;
        opacity: 0;
        perspective: 1000px;
        cursor: pointer;
      }

      .polaroid-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        box-shadow: 0 4px 10px var(--polaroid-shadow);
      }

      /* Animation au survol */
      .polaroid:hover .polaroid-inner {
        transform: rotateY(180deg);
      }

      /* Styles pour le recto et le verso */
      .polaroid-front,
      .polaroid-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border: 8px solid var(--polaroid-border);
      }

      .polaroid-front {
        background-size: cover;
        background-position: center;
      }

      .polaroid-back {
        background-color: var(--polaroid-border);
        transform: rotateY(180deg);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 15px;
        color: var(--text-color);
      }

      .polaroid-title {
        font-size: clamp(14px, 1.8vw, 20px);
        font-weight: 600;
        margin-bottom: 10px;
      }

      .polaroid-description {
        font-size: clamp(12px, 1.4vw, 16px);
        font-weight: 300;
      }
      .p1 {
        top: -6%;
        left: 5%;
        --rotation: -8deg;
      }
      .p1 .polaroid-inner {
        transform: rotate(-8deg);
      }
      .p1:hover .polaroid-inner {
        transform: rotate(-8deg) rotateY(180deg);
      }

      .p2 {
        bottom: -2%;
        left: 3%;
        --rotation: 10deg;
      }
      .p2 .polaroid-inner {
        transform: rotate(10deg);
      }
      .p2:hover .polaroid-inner {
        transform: rotate(10deg) rotateY(180deg);
      }

      .p3 {
        top: 20%;
        right: -5%;
        --rotation: 5deg;
      }
      .p3 .polaroid-inner {
        transform: rotate(5deg);
      }
      .p3:hover .polaroid-inner {
        transform: rotate(5deg) rotateY(180deg);
      }

      .p4 {
        left: 2%;
        top: 40%;
        --rotation: -6deg;
      }
      .p4 .polaroid-inner {
        transform: rotate(-6deg);
      }
      .p4:hover .polaroid-inner {
        transform: rotate(-6deg) rotateY(180deg);
      }

      .p5 {
        right: -5%;
        bottom: -4%;
        --rotation: 12deg;
      }
      .p5 .polaroid-inner {
        transform: rotate(12deg);
      }
      .p5:hover .polaroid-inner {
        transform: rotate(12deg) rotateY(180deg);
      }

      .p6 {
        top: 10%;
        right: 10%;
        --rotation: 7deg;
        z-index: 0; /* Z-index inférieur à celui de p3 */
      }
      .p6 .polaroid-inner {
        transform: rotate(7deg);
      }
      .p6:hover .polaroid-inner {
        transform: rotate(7deg) rotateY(180deg);
      }

      #scroll-message {
        font-size: clamp(16px, 2vw, 22px);
        font-weight: 600;
        letter-spacing: 0.02em;
        margin: 0;
        color: var(--text-color);
        text-shadow: 0px 0px 2px var(--bg-color);
        transition: color 0.3s, text-shadow 0.3s;
      }

      #scroll-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulseAttention 2s infinite;
      }

      #scroll-icon svg {
        width: 32px;
        height: 32px;
        fill: var(--text-color);
        transition: fill 0.3s;
      }

      #scroll-icon p {
        color: var(--text-color);
        transition: color 0.3s;
      }

      @keyframes arrowBounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }

      @keyframes arrowScroll {
        0% {
          opacity: 1;
          transform: translateY(0);
        }
        30% {
          opacity: 1;
          transform: translateY(15px);
        }
        60% {
          opacity: 0;
          transform: translateY(20px);
        }
        61% {
          opacity: 0;
          transform: translateY(0);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulseAttention {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* Amélioration pour mobile */
      @media (max-width: 767px) {
        .polaroid {
          width: 30vw; /* Plus grand sur mobile */
        }

        .polaroid-title {
          font-size: 14px;
        }

        .polaroid-description {
          font-size: 12px;
        }

        /* Instructions visuelles pour mobile */
        .polaroid::after {
          position: absolute;
          bottom: -20px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 10px;
          color: var(--text-color);
          opacity: 0.7;
          text-align: center;
          width: 100%;
          pointer-events: none;
          z-index: 5;
          text-shadow: 0 0 2px var(--bg-color);
        }

        /* Désactiver l'effet de survol sur mobile */
        .polaroid:hover .polaroid-inner {
          transform: none;
        }
      }

      /* Animation d'entrée pour les polaroids */
      @keyframes fadeInPolaroid {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Effet de clic */
      .polaroid:active .polaroid-inner {
        box-shadow: 0 2px 5px var(--polaroid-shadow);
      }

      /* Feedback visuel pour le retournement tactile */
      .flip-animation {
        animation: flipEffect 0.6s ease-in-out;
      }

      @keyframes flipEffect {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
    <!-- Chargement de la configuration d'environnement en production -->
    <script>
      window.ENV = { API_URL: "", NODE_ENV: "development" };
    </script>
    <script src="/env-config.js" type="module"></script>
  </head>
  <body>
    <!-- Landing page avec Three.js -->
    <div id="landing-container">
      <!-- Toggles en haut à droite -->
      <div class="toggle-container">
        <div class="toggle">
          <span class="toggle-label" id="theme-label">Thème</span>
          <label class="toggle-switch" aria-label="Interrupteur de thème">
            <input
              type="checkbox"
              id="theme-toggle"
              aria-label="Basculer entre thème clair et sombre"
            />
            <span class="slider"></span>
          </label>
        </div>
        <div class="toggle">
          <span class="toggle-label" id="lang-label">FR</span>
          <label class="toggle-switch" aria-label="Interrupteur de langue">
            <input
              type="checkbox"
              id="lang-toggle"
              aria-label="Basculer entre français et anglais"
            />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <canvas
        id="webgl"
        aria-label="Visualisation 3D de la lampe FOCUS.01"
      ></canvas>
      <div id="scrollArea"></div>
      <h1 id="brand-title">ALTO LILLE</h1>
      <p class="caption ml" id="cap0">PLA éco‑responsable</p>
      <p class="caption tr" id="cap1">Montage ultra simple</p>
      <p class="caption mr" id="cap2">Chêne écogéré</p>
      <p class="caption br" id="cap3">
        Conçu & fabriqué par Alto Lille en France
      </p>
      <p class="caption tl" id="cap4">LED 60 W E14 incluse</p>
      <p class="caption bl" id="cap5">Emballage éco‑responsable</p>
      <div id="cta">Visiter la boutique</div>

      <!-- Indicateur de défilement -->
      <div id="scroll-indicator">
        <p id="scroll-message">Produit disponible à la vente</p>
        <div id="scroll-icon">
          <p>Scroll vers le bas !</p>
        </div>
      </div>

      <!-- Polaroids avec images du site -->
      <div class="polaroid p1" data-link="/sea-cle">
        <div class="polaroid-inner">
          <div
            class="polaroid-front"
            style="background-image: url('/images/sea-cle.jpg')"
          ></div>
          <div class="polaroid-back">
            <div class="polaroid-title">Sea Clé</div>
            <div class="polaroid-description">
              Découvrez l'histoire derrière cette création unique
            </div>
          </div>
        </div>
      </div>
      <div class="polaroid p2" data-link="/braderie-de-l-art">
        <div class="polaroid-inner">
          <div
            class="polaroid-front"
            style="background-image: url('/images/braderie-de-l-art.png')"
          ></div>
          <div class="polaroid-back">
            <div class="polaroid-title">Braderie de l'Art</div>
            <div class="polaroid-description">Une exposition emblématique</div>
          </div>
        </div>
      </div>
      <div class="polaroid p3" data-link="/waterfall">
        <div class="polaroid-inner">
          <div
            class="polaroid-front"
            style="background-image: url('/images/Waterfall.jpg')"
          ></div>
          <div class="polaroid-back">
            <div class="polaroid-title">Waterfall</div>
            <div class="polaroid-description">
              L'eau comme source d'inspiration
            </div>
          </div>
        </div>
      </div>
      <div class="polaroid p4" data-link="/lowtech-vynil">
        <div class="polaroid-inner">
          <div
            class="polaroid-front"
            style="background-image: url('/images/lowtech-vynil.jpg')"
          ></div>
          <div class="polaroid-back">
            <div class="polaroid-title">Lowtech Vynil</div>
            <div class="polaroid-description">Création innovante</div>
          </div>
        </div>
      </div>
      <div class="polaroid p5" data-link="/chaussures-custom">
        <div class="polaroid-inner">
          <div
            class="polaroid-front"
            style="background-image: url('/images/chaussures-custom.jpg')"
          ></div>
          <div class="polaroid-back">
            <div class="polaroid-title">Chaussures Custom</div>
            <div class="polaroid-description">
              L'artisanat rencontre le style personnel
            </div>
          </div>
        </div>
      </div>
      <div class="polaroid p6" data-link="/qui-suis-je">
        <div class="polaroid-inner">
          <div
            class="polaroid-front"
            style="
              background-image: url('https://www.alto-lille.fr/uploads/6d140285-f1c2-4a80-bfde-d9848a4c5f92.jpg');
            "
          ></div>
          <div class="polaroid-back">
            <div class="polaroid-title">Qui suis-je</div>
            <div class="polaroid-description">À propos de l'artiste</div>
          </div>
        </div>
      </div>

      <footer class="animate fade-in-up delay-8">
        © 2025 Alto Lille - Tous droits réservés
      </footer>
    </div>

    <!-- App React (caché par défaut) -->
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
      import { RoomEnvironment } from "three/addons/environments/RoomEnvironment.js";

      /* ===== CONFIG ===== */
      const CFG = {
        urls: [
          "https://raw.githubusercontent.com/Zlarb02/test-landing/main/src/assets/focus.glb",
          "./focus.glb",
          "/images/focus.glb",
        ],
        intro: 0.08,
        rotEnd: 0.75,
        timeScale: 1.2,
        legend: { seg: 0.12, fade: 0.04 },
        travelAmp:
          matchMedia("(prefers-reduced-motion: reduce)").matches ||
          innerWidth < 600
            ? 0.25
            : 0.6,
        colours: { bg: "#fff", txt: "#111", key: "#ffffff", rim: "#66ccff" },
        // Configuration du déplacement horizontal du canvas
        slideRight: {
          start: 0.6, // Moment où le déplacement commence (correspond au début de la disparition du texte "emballage éco-responsable")
          end: 0.9, // Moment où le déplacement est complet
          amount: 25, // Pourcentage de déplacement vers la droite
        },
      };
      /* helpers */
      const L = (a, b, t) => a + (b - a) * t,
        C = (v) => Math.max(0, Math.min(v, 1));

      /* ===== RENDERER & SCENE ===== */
      // Déterminer si nous sommes sur un grand écran (largeur > 1440px)
      const isLargeScreen = window.innerWidth > 1440;

      const renderer = new THREE.WebGLRenderer({
        canvas: webgl,
        antialias: true, // Toujours activer l'anti-aliasing
        powerPreference: "high-performance",
        precision: isLargeScreen ? "highp" : "mediump",
        stencil: false, // Optimisation pour les performances
      });
      renderer.setSize(innerWidth, innerHeight);

      // Adapter le pixel ratio en fonction de la taille de l'écran
      const maxPixelRatio = isLargeScreen
        ? Math.min(window.devicePixelRatio, 2)
        : Math.min(window.devicePixelRatio, 1.5);
      renderer.setPixelRatio(maxPixelRatio);

      // Définir la couleur de fond en fonction du thème actuel
      const isDarkMode = document.body.classList.contains("dark-mode");
      renderer.setClearColor(isDarkMode ? "#121212" : CFG.colours.bg, 1);
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.1;

      // Optimisations supplémentaires pour les grands écrans
      if (isLargeScreen) {
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Ombres adoucies
        renderer.outputColorSpace = THREE.SRGBColorSpace; // Espace couleur correct
      }

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        60,
        innerWidth / innerHeight,
        0.1,
        1000
      );
      scene.environment = new THREE.PMREMGenerator(renderer).fromScene(
        new RoomEnvironment(renderer)
      ).texture;
      scene.add(new THREE.AmbientLight(0xffffff, 1));
      [
        ["key", 6, 10, 10],
        ["rim", -6, 7, -10],
      ].forEach(([k, x, y, z]) => {
        const s = new THREE.SpotLight(
          CFG.colours[k],
          1.2,
          0,
          Math.PI / 8,
          0.25
        );
        s.position.set(x, y, z);
        scene.add(s);
      });

      /* ===== LOAD GLB ===== */
      let center = new THREE.Vector3(),
        R = 1,
        r0,
        r1,
        y0,
        y1,
        rIntro,
        yIntro,
        mixer,
        clip = 4,
        act;
      const loader = new GLTFLoader();
      for (const url of CFG.urls) {
        try {
          await new Promise((res, rej) =>
            loader.load(
              url,
              (g) => {
                scene.add(g.scene);
                g.scene.traverse(
                  (o) =>
                    o.material?.isMeshStandardMaterial &&
                    (o.material.envMapIntensity = 1.1)
                );
                ({ radius: R, center } = new THREE.Box3()
                  .setFromObject(g.scene)
                  .getBoundingSphere(new THREE.Sphere()));
                r0 = R * 1.9;
                r1 = R * 7;
                y0 = center.y;
                y1 = center.y - R * 0.05;
                rIntro = R * 2;
                yIntro = center.y + R * 0.8;
                if (g.animations[0]) {
                  mixer = new THREE.AnimationMixer(g.scene);
                  act = mixer.clipAction(g.animations[0]);
                  act.setLoop(THREE.LoopOnce, 0);
                  act.clampWhenFinished = true;
                  act.play();
                  clip = g.animations[0].duration;
                }
                res();
              },
              undefined,
              rej
            )
          );
          break;
        } catch {}
      }

      /* ===== INTERACTION ===== */
      let prog = 0;
      addEventListener(
        "scroll",
        (e) => {
          const m = document.body.scrollHeight - innerHeight;
          prog = C(scrollY / m);
          lastScrollTime = Date.now(); // Mettre à jour le temps du dernier défilement
          hasScrolled = true; // Marquer que l'utilisateur a défilé
        },
        { passive: true }
      );
      addEventListener("resize", () => {
        // Recalculer si nous sommes sur un grand écran à chaque redimensionnement
        const newIsLargeScreen = window.innerWidth > 1440;

        // Adapter le pixel ratio en fonction de la nouvelle taille
        const newMaxPixelRatio = newIsLargeScreen
          ? Math.min(window.devicePixelRatio, 2)
          : Math.min(window.devicePixelRatio, 1.5);

        renderer.setPixelRatio(newMaxPixelRatio);
        renderer.setSize(innerWidth, innerHeight);
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();

        // Mettre à jour les optimisations en fonction de la nouvelle taille
        if (newIsLargeScreen !== isLargeScreen) {
          renderer.shadowMap.enabled = newIsLargeScreen;
          renderer.shadowMap.type = newIsLargeScreen
            ? THREE.PCFSoftShadowMap
            : THREE.BasicShadowMap;
        }
      });

      /* captions */
      const caps = [cap0, cap1, cap2, cap3, cap4, cap5];
      const showCaps = (t) =>
        caps.forEach((el, i) => {
          const a = i * CFG.legend.seg,
            b = a + CFG.legend.seg;
          let o = 0;
          if (t >= a - CFG.legend.fade && t <= b + CFG.legend.fade)
            o =
              t < a
                ? (t - (a - CFG.legend.fade)) / CFG.legend.fade
                : t > b
                ? 1 - (t - b) / CFG.legend.fade
                : 1;
          el.style.opacity = o;
        });

      /* ===== LOOP ===== */
      const OFFSET = Math.PI * 0.5; // Changé de Math.PI à Math.PI * 0.5 pour une vue plus frontale
      // Variables pour contrôler l'animation
      let animationActive = true;
      let animFrameId;
      let autoRotationAngle = OFFSET;
      let lastScrollTime = 0; // Initialisé à 0 pour que la rotation démarre immédiatement
      let hasScrolled = false; // Pour suivre si l'utilisateur a déjà défilé
      const AUTO_ROTATION_SPEED = 0.005; // Vitesse de rotation automatique
      const SCROLL_TIMEOUT = 1000; // Temps d'inactivité avant reprise de la rotation auto (en ms)

      // Fonction d'animation
      function anim() {
        if (!animationActive) return;
        animFrameId = requestAnimationFrame(anim);

        if (!R) return;

        // Rotation automatique dans la phase d'intro si l'utilisateur n'a jamais défilé ou s'il n'y a pas eu d'activité récente
        if (
          prog < CFG.intro &&
          (!hasScrolled || Date.now() - lastScrollTime > SCROLL_TIMEOUT)
        ) {
          autoRotationAngle += AUTO_ROTATION_SPEED;
        }

        if (prog < CFG.intro) {
          const k = prog / CFG.intro;
          const r = L(rIntro, r0, k),
            y = L(yIntro, y0, k);
          camera.position.set(
            center.x + Math.cos(autoRotationAngle) * r,
            y,
            center.z + Math.sin(autoRotationAngle) * r
          );
          camera.lookAt(center);
          caps.forEach((e) => (e.style.opacity = 0));
          cta.style.opacity = 0;
          // Afficher le titre ALTO LILLE dès le début
          document.getElementById("brand-title").style.opacity = 1;
          // Afficher l'indicateur de défilement dans la phase d'intro
          document.getElementById("scroll-indicator").style.opacity = 1;
          // Afficher les polaroids
          document
            .querySelectorAll(".polaroid")
            .forEach((p) => (p.style.opacity = 1));
          if (act) {
            act.time = clip - k * (clip - Math.min(5.2, clip));
            mixer.update(0);
          }
        } else {
          const t = (prog - CFG.intro) / (1 - CFG.intro),
            rot = C(t / CFG.rotEnd),
            ang = OFFSET - rot * Math.PI * 2;
          const r = L(r0, r1, t);
          let y = L(y0, y1, t);
          const { travelAmp: a } = CFG;
          y +=
            t <= 0.3
              ? a * R * C((t - 0.15) / 0.15)
              : t < 0.55
              ? a * R * C((0.55 - t) / 0.25) * 0.7
              : 0;
          camera.position.set(
            center.x + Math.cos(ang) * r,
            y,
            center.z + Math.sin(ang) * r
          );
          camera.lookAt(center.x, center.y - R * 0.15, center.z);
          showCaps(t);
          // Faire disparaître le titre ALTO LILLE progressivement au début de la transition
          const titleOpacity = t < 0.1 ? 1 - t * 10 : 0;
          document.getElementById("brand-title").style.opacity = titleOpacity;
          // Masquer l'indicateur de défilement dès que l'utilisateur commence à défiler
          document.getElementById("scroll-indicator").style.opacity = 0;
          // Faire disparaître les polaroids avant que "PLA éco-responsable" n'apparaisse
          // La première légende apparaît à t = 0.04 (CFG.legend.fade)
          const firstCaptionStart = CFG.legend.fade; // 0.04
          const polaroidOpacity =
            t < firstCaptionStart ? 1 - t / firstCaptionStart : 0;
          document
            .querySelectorAll(".polaroid")
            .forEach((p) => (p.style.opacity = polaroidOpacity));
          cta.style.opacity = t > 0.95 ? C((t - 0.95) / 0.05) : 0;
          act &&
            ((act.time = Math.min(t * CFG.timeScale, 1) * clip),
            mixer.update(0));

          // Déplacer le canvas vers la droite lorsque "emballage éco-responsable" commence à disparaître
          const { slideRight } = CFG;
          if (t >= slideRight.start && t <= slideRight.end) {
            // Calcul du pourcentage de déplacement entre 0 et 1
            const slideProgress = C(
              (t - slideRight.start) / (slideRight.end - slideRight.start)
            );
            // Application du margin-left en pourcentage
            document.getElementById("webgl").style.marginLeft = `${
              slideProgress * slideRight.amount
            }%`;
          } else if (t < slideRight.start) {
            // S'assurer que le canvas est à sa position initiale avant le début du déplacement
            document.getElementById("webgl").style.marginLeft = "0";
          } else if (t > slideRight.end) {
            // S'assurer que le canvas est complètement déplacé après la fin du déplacement
            document.getElementById(
              "webgl"
            ).style.marginLeft = `${slideRight.amount}%`;
          }
        }
        renderer.render(scene, camera);
      }

      // Démarrer l'animation
      anim();

      /* ===== NAVIGATION ===== */
      document.getElementById("cta").addEventListener("click", function () {
        navigateToShop();
      });

      // Gestion de la navigation
      function navigateToShop() {
        // Mettre à jour l'URL
        history.pushState({}, "", "/shop");
        // Arrêter l'animation Three.js
        animationActive = false;
        if (animFrameId) {
          cancelAnimationFrame(animFrameId);
          animFrameId = null;
        }
        // Afficher l'app React et masquer la landing
        document.getElementById("landing-container").style.display = "none";
        document.getElementById("root").style.display = "block";
        // Notifier l'app React du changement
        window.dispatchEvent(
          new CustomEvent("routeChange", { detail: { path: "/shop" } })
        );
      }

      function handleNavigation() {
        // Vérifier l'URL actuelle
        const path = window.location.pathname;
        if (path === "/" || path === "") {
          // Afficher la landing sur la page d'accueil uniquement
          document.getElementById("landing-container").style.display = "block";
          document.getElementById("root").style.display = "none";

          // Redémarrer l'animation Three.js
          animationActive = true;
          // Réinitialiser la position de défilement
          window.scrollTo(0, 0);
          // Redémarrer toujours l'animation pour s'assurer qu'elle fonctionne
          if (animFrameId) {
            cancelAnimationFrame(animFrameId); // Annuler l'animation précédente si elle existait
          }
          animFrameId = requestAnimationFrame(anim); // Relancer une nouvelle boucle d'animation
        } else {
          // Afficher l'app React pour TOUS les autres chemins (sans exception)
          document.getElementById("landing-container").style.display = "none";
          document.getElementById("root").style.display = "block";

          // Arrêter l'animation Three.js complètement
          animationActive = false;
          if (animFrameId) {
            cancelAnimationFrame(animFrameId);
            animFrameId = null;
          }
        }
      }

      // Écouter les changements d'URL
      window.addEventListener("popstate", handleNavigation);

      // Écouter l'événement personnalisé de retour à la landing page depuis l'app React
      window.addEventListener("returnToLanding", function () {
        // Réinitialiser les variables d'animation
        prog = 0;
        animationActive = true;

        // Annuler l'animation précédente si elle existait
        if (animFrameId) {
          cancelAnimationFrame(animFrameId);
          animFrameId = null;
        }

        // Relancer une nouvelle boucle d'animation
        animFrameId = requestAnimationFrame(anim);
      });

      // Gestion du thème sombre/clair
      const themeToggle = document.getElementById("theme-toggle");
      const themeLabel = document.getElementById("theme-label");

      // Vérifier le mode préféré de l'utilisateur ou le mode stocké
      const prefersDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      const savedTheme = localStorage.getItem("theme");

      // Appliquer le thème initial
      if (savedTheme === "dark" || (!savedTheme && prefersDarkMode)) {
        document.body.classList.add("dark-mode");
        themeToggle.checked = true;
        themeLabel.textContent = "Sombre";
        // Mettre à jour la couleur du renderer si déjà défini
        if (typeof renderer !== "undefined") {
          renderer.setClearColor("#000000", 1);
        }
      } else {
        themeLabel.textContent = "Clair";
      }

      // Écouter les changements de thème
      themeToggle.addEventListener("change", function () {
        if (this.checked) {
          document.body.classList.add("dark-mode");
          localStorage.setItem("theme", "dark");
          themeLabel.textContent = "Sombre";
          // Mettre à jour la couleur de fond du renderer pour le mode sombre
          renderer.setClearColor("#000000", 1);
        } else {
          document.body.classList.remove("dark-mode");
          localStorage.setItem("theme", "light");
          themeLabel.textContent = "Clair";
          // Mettre à jour la couleur de fond du renderer pour le mode clair
          renderer.setClearColor(CFG.colours.bg, 1);
        }
      });

      // Gestion du changement de langue
      const langToggle = document.getElementById("lang-toggle");
      const langLabel = document.getElementById("lang-label");

      // Objets de traduction (français et anglais)
      const translations = {
        fr: {
          cap0: "PLA éco‑responsable",
          cap1: "Montage ultra simple",
          cap2: "Chêne écogéré",
          cap3: "Conçu & fabriqué par Alto Lille en France",
          cap4: "LED 60 W E14 incluse",
          cap5: "Emballage éco‑responsable",
          cta: "Visiter la boutique",
          theme: "Clair",
          themeDark: "Sombre",
          scroll: "Produit disponible à la vente",
          scrollAction: "Scroll vers le bas !",
          footer: "© 2025 Alto Lille - Tous droits réservés",
        },
        en: {
          cap0: "Eco-friendly PLA",
          cap1: "Ultra simple assembly",
          cap2: "Sustainable oak",
          cap3: "Designed & made by Alto Lille in France",
          cap4: "60W E14 LED bulb included",
          cap5: "Eco-responsible packaging",
          cta: "Visit the shop",
          theme: "Light",
          themeDark: "Dark",
          scroll: "Product available for purchase",
          scrollAction: "Scroll down!",
          footer: "© 2025 Alto Lille - All rights reserved",
        },
      };

      // Vérifier la langue stockée
      const savedLang = localStorage.getItem("lang") || "fr";

      // Appliquer la langue initiale
      if (savedLang === "en") {
        langToggle.checked = true;
        langLabel.textContent = "EN";
        applyLanguage("en");
      } else {
        langLabel.textContent = "FR";
      }

      // Fonction pour appliquer une langue
      function applyLanguage(lang) {
        const t = translations[lang];
        document.getElementById("cap0").textContent = t.cap0;
        document.getElementById("cap1").textContent = t.cap1;
        document.getElementById("cap2").textContent = t.cap2;
        document.getElementById("cap3").textContent = t.cap3;
        document.getElementById("cap4").textContent = t.cap4;
        document.getElementById("cap5").textContent = t.cap5;
        document.getElementById("cta").textContent = t.cta;
        document.getElementById("scroll-message").textContent = t.scroll;
        document.querySelector("#scroll-icon p").textContent = t.scrollAction;
        document.querySelector("footer").textContent = t.footer;

        // Mettre à jour les libellés des toggles en fonction de la langue
        if (themeToggle.checked) {
          themeLabel.textContent = t.themeDark;
        } else {
          themeLabel.textContent = t.theme;
        }
      }

      // Écouter les changements de langue
      langToggle.addEventListener("change", function () {
        if (this.checked) {
          langLabel.textContent = "EN";
          localStorage.setItem("lang", "en");
          applyLanguage("en");
        } else {
          langLabel.textContent = "FR";
          localStorage.setItem("lang", "fr");
          applyLanguage("fr");
        }
      });

      // Exécuter au chargement initial
      document.addEventListener("DOMContentLoaded", function () {
        handleNavigation();
      });

      // S'assurer que la page est correctement initialisée immédiatement (sans attendre les événements)
      handleNavigation();

      /* ===== EFFET DE PARALLAXE POUR LES POLAROIDS ===== */
      // Déclarer les variables pour l'effet de parallaxe
      let mouseX = 0;
      let mouseY = 0;
      let targetX = 0;
      let targetY = 0;
      let windowHalfX = window.innerWidth / 2;
      let windowHalfY = window.innerHeight / 2;
      const polaroids = document.querySelectorAll(".polaroid");

      // Variables pour gérer le délai avant la navigation
      let navigationTimeout = null;
      let isFlipping = false;

      // Définir des facteurs de force différents pour chaque polaroid (plus la valeur est élevée, plus l'effet est prononcé)
      const parallaxIntensity = [
        0.04, // p1
        0.025, // p2
        0.05, // p3
        0.035, // p4
        0.03, // p5
        0.045, // p6
      ];

      // Configuration du facteur de lissage (plus la valeur est basse, plus le mouvement est fluide)
      const smoothFactor = 0.1;

      // Écouter les mouvements de la souris
      document.addEventListener(
        "mousemove",
        function (e) {
          // Calculer la position relative de la souris par rapport au centre de l'écran
          targetX = e.clientX - windowHalfX;
          targetY = e.clientY - windowHalfY;
        },
        { passive: true }
      );

      // Animation fluide avec requestAnimationFrame
      function updateParallax() {
        // Interpolation fluide entre la position actuelle et la position cible
        mouseX += (targetX - mouseX) * smoothFactor;
        mouseY += (targetY - mouseY) * smoothFactor;

        // Appliquer l'effet de parallaxe à chaque polaroid avec une intensité différente
        polaroids.forEach((polaroid, index) => {
          if (window.getComputedStyle(polaroid).opacity > 0 && !isFlipping) {
            // N'appliquer l'effet que si le polaroid est visible et n'est pas en train de se retourner
            const intensity = parallaxIntensity[index] || 0.03; // Valeur par défaut si index non défini
            const moveX = mouseX * intensity;
            const moveY = mouseY * intensity;

            // Appliquer la translation au polaroid lui-même
            polaroid.style.transform = `translate(${moveX}px, ${moveY}px)`;
          }
        });

        // Continuer l'animation
        requestAnimationFrame(updateParallax);
      }

      // Démarrer l'animation de parallaxe
      requestAnimationFrame(updateParallax);

      // Mettre à jour les dimensions lors du redimensionnement de la fenêtre
      window.addEventListener(
        "resize",
        function () {
          windowHalfX = window.innerWidth / 2;
          windowHalfY = window.innerHeight / 2;
        },
        { passive: true }
      );

      // Fonction pour réinitialiser la position des polaroids quand la souris quitte la fenêtre
      document.addEventListener("mouseleave", function () {
        polaroids.forEach((polaroid) => {
          polaroid.style.transform = "";
        });
      });

      // Fonction pour détecter l'appareil mobile
      function isMobileDevice() {
        return (
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          ) || window.innerWidth < 768
        );
      }

      // Ajouter les interactions pour les polaroids
      polaroids.forEach((polaroid) => {
        const link = polaroid.getAttribute("data-link");

        // Gestion des événements tactiles pour les appareils mobiles
        polaroid.addEventListener("touchstart", function (e) {
          // Empêcher le comportement par défaut pour éviter le scroll
          e.preventDefault();

          // Si le polaroid est déjà retourné, naviguer vers le lien
          const isFlipped = polaroid
            .querySelector(".polaroid-inner")
            .style.transform.includes("rotateY(180deg)");

          if (isFlipped) {
            if (link) {
              window.location.href = link;
            }
          } else {
            // Si non retourné, faire pivoter le polaroid
            const inner = polaroid.querySelector(".polaroid-inner");

            // Récupérer la rotation actuelle
            const currentRotation = getComputedStyle(
              polaroid.querySelector(".polaroid-inner")
            ).transform;
            const className = polaroid.classList[1]; // p1, p2, etc.
            const rotation =
              getComputedStyle(polaroid).getPropertyValue("--rotation") ||
              "0deg";

            // Appliquer la transformation de retournement
            inner.style.transform = `rotate(${rotation}) rotateY(180deg)`;
            isFlipping = true;

            // Retarder la possibilité de cliquer à nouveau pour éviter les doubles actions
            setTimeout(() => {
              isFlipping = false;
            }, 600);
          }
        });

        // Gestion des clics pour les ordinateurs de bureau
        polaroid.addEventListener("click", function (e) {
          // Si l'appareil est mobile, laisser touchstart gérer l'interaction
          if (isMobileDevice()) return;

          // Si le polaroid est en cours d'animation de retournement, ne rien faire
          if (isFlipping) return;

          const inner = polaroid.querySelector(".polaroid-inner");
          const isFlipped = inner.style.transform.includes("rotateY(180deg)");

          if (isFlipped && link) {
            // Si déjà retourné et qu'on clique, naviguer vers le lien
            window.location.href = link;
          }
        });

        // Ajouter une interaction de survol pour les ordinateurs de bureau
        if (!isMobileDevice()) {
          polaroid.addEventListener("mouseover", function () {
            isFlipping = true;

            // Retarder la réactivation du parallaxe après la fin de l'animation
            setTimeout(() => {
              isFlipping = false;
            }, 600);
          });
        }
      });
    </script>
    <script>
      // Script d'initialisation des polaroids
      document.addEventListener("DOMContentLoaded", function () {
        const polaroids = document.querySelectorAll(".polaroid");

        // Ajouter une classe pour gérer l'animation d'entrée
        polaroids.forEach((polaroid, index) => {
          // Déterminer la rotation actuelle
          const rotation =
            getComputedStyle(polaroid).getPropertyValue("--rotation") || "0deg";

          // Ajouter un léger délai pour chaque polaroid
          setTimeout(() => {
            // Ajouter la classe pour l'animation d'entrée
            polaroid.style.animation = `fadeInPolaroid 0.8s ease-out forwards`;
          }, index * 150);

          // Gérer la compatibilité tactile
          if ("ontouchstart" in window) {
            // Désactiver l'effet de survol sur les appareils tactiles
            polaroid.classList.add("touch-device");

            // Ajouter une animation tactile
            polaroid.addEventListener("touchend", function () {
              const inner = this.querySelector(".polaroid-inner");
              inner.classList.add("flip-animation");

              setTimeout(() => {
                inner.classList.remove("flip-animation");
              }, 600);
            });
          }
        });
      });
    </script>
  </body>
</html>
